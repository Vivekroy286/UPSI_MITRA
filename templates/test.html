<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSI Mock Test - {{ paper.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <!-- Header -->
    <div class="bg-white shadow-lg p-2 md:p-4 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
        <div class="flex items-center space-x-2 md:space-x-4 flex-wrap">
            <div id="timer" class="bg-red-100 px-2 md:px-4 py-1 md:py-2 rounded-lg">
                <i class="fas fa-clock text-red-600 mr-1 md:mr-2"></i>
                <span class="text-red-600 font-bold text-sm md:text-base" id="timeDisplay">120:00</span>
            </div>
            <div id="sectionName" class="bg-blue-100 px-2 md:px-4 py-1 md:py-2 rounded-lg">
                <span class="text-blue-600 font-bold text-xs md:text-sm">Section A: General Hindi</span>
            </div>
        </div>
        <div class="flex items-center space-x-2 md:space-x-4">
            <div class="text-xs md:text-sm text-gray-600">
                Q <span id="currentQ">1</span>/<span id="totalQ">160</span>
            </div>
            <button onclick="toggleNavigator()" class="bg-blue-500 text-white px-2 md:px-4 py-1 md:py-2 rounded-lg hover:bg-blue-600 text-sm">
                <i class="fas fa-th-large mr-1 md:mr-2"></i><span class="hidden md:inline">Questions</span>
            </button>
            <button onclick="submitTest()" class="bg-red-500 text-white px-2 md:px-4 py-1 md:py-2 rounded-lg hover:bg-red-600 text-sm">
                <i class="fas fa-paper-plane mr-1 md:mr-2"></i><span class="hidden md:inline">Submit</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex h-full">
        <!-- Question Panel -->
        <div class="flex-1 p-4 md:p-8 overflow-y-auto pb-32 md:pb-20">
            <div id="questionContainer" class="max-w-4xl mx-auto">
                <!-- Question will be loaded here -->
            </div>
        </div>

        <!-- Question Navigator (Hidden by default) -->
        <div id="questionNavigator" class="w-full md:w-80 bg-white shadow-lg p-4 overflow-y-auto fixed right-0 top-16 md:top-20 bottom-16 md:bottom-20 transform translate-x-full transition-transform duration-300 z-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 text-sm md:text-base">Question Navigator</h3>
                <button onclick="toggleNavigator()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="grid grid-cols-8 md:grid-cols-5 gap-1 md:gap-2 mb-6" id="questionGrid">
                <!-- Question numbers will be generated here -->
            </div>
            <div class="space-y-2 text-xs md:text-sm">
                <div class="flex items-center">
                    <div class="w-3 h-3 md:w-4 md:h-4 bg-green-500 rounded mr-2"></div>
                    <span>Answered</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 md:w-4 md:h-4 bg-yellow-500 rounded mr-2"></div>
                    <span>Marked</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 md:w-4 md:h-4 bg-red-500 rounded mr-2"></div>
                    <span>Not Answered</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 md:w-4 md:h-4 bg-blue-500 rounded mr-2"></div>
                    <span>Current</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="bg-white shadow-lg p-2 md:p-4 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0 fixed bottom-0 left-0 right-0 z-10">
        <button onclick="previousQuestion()" class="bg-gray-500 text-white px-4 md:px-6 py-2 rounded-lg hover:bg-gray-600 text-sm md:text-base w-full md:w-auto">
            <i class="fas fa-arrow-left mr-1 md:mr-2"></i>Previous
        </button>
        <div class="flex space-x-2 md:space-x-4 w-full md:w-auto">
            <button onclick="markForReview()" class="bg-yellow-500 text-white px-3 md:px-6 py-2 rounded-lg hover:bg-yellow-600 text-xs md:text-base flex-1 md:flex-none">
                <i class="fas fa-bookmark mr-1 md:mr-2"></i><span class="hidden sm:inline">Mark</span>
            </button>
            <button onclick="saveAndNext()" class="bg-green-500 text-white px-3 md:px-6 py-2 rounded-lg hover:bg-green-600 text-xs md:text-base flex-1 md:flex-none">
                <i class="fas fa-save mr-1 md:mr-2"></i><span class="hidden sm:inline">Save &</span> Next
            </button>
        </div>
        <button onclick="nextQuestion()" class="bg-blue-500 text-white px-4 md:px-6 py-2 rounded-lg hover:bg-blue-600 text-sm md:text-base w-full md:w-auto">
            Next<i class="fas fa-arrow-right ml-1 md:ml-2"></i>
        </button>
    </div>

    <script>
        const questions = {{ questions|safe }};
        const paperId = {{ paper.id }};
        let currentQuestionIndex = 0;
        let answers = {};
        let markedQuestions = new Set();
        let timeLeft = 7200; // 120 minutes in seconds
        
        function initTest() {
            generateQuestionGrid();
            loadQuestion(0);
            startTimer();
        }
        
        function generateQuestionGrid() {
            const grid = document.getElementById('questionGrid');
            for (let i = 0; i < questions.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-6 h-6 md:w-8 md:h-8 rounded text-xs md:text-sm font-bold bg-red-500 text-white hover:bg-red-600';
                btn.onclick = () => loadQuestion(i);
                btn.id = `q-${i}`;
                grid.appendChild(btn);
            }
        }
        
        function loadQuestion(index) {
            currentQuestionIndex = index;
            const question = questions[index];
            
            // Update current question indicator
            document.querySelectorAll('[id^="q-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500');
            });
            document.getElementById(`q-${index}`).classList.add('bg-blue-500');
            
            // Update section name
            const sectionNames = {
                'general_hindi': 'Section A: General Hindi',
                'law_constitution': 'Section B: Law & Constitution', 
                'general_knowledge': 'Section C: General Knowledge',
                'numerical_mental': 'Section D: Numerical & Mental Ability'
            };
            document.getElementById('sectionName').innerHTML = `<span class="text-blue-600 font-bold">${sectionNames[question.section]}</span>`;
            
            // Update question counter
            document.getElementById('currentQ').textContent = index + 1;
            document.getElementById('totalQ').textContent = questions.length;
            
            // Load question content
            const container = document.getElementById('questionContainer');
            container.innerHTML = `
                <div class="bg-white rounded-2xl shadow-lg p-4 md:p-8">
                    <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4 md:mb-6 leading-relaxed">Q${index + 1}. ${question.text}</h2>
                    <div class="space-y-3 md:space-y-4">
                        <label class="flex items-start md:items-center p-3 md:p-4 rounded-xl hover:bg-blue-50 cursor-pointer transition-colors duration-200 group">
                            <input type="radio" name="current_question" value="A" class="mr-3 md:mr-4 w-4 h-4 md:w-5 md:h-5 text-blue-600 mt-1 md:mt-0" ${answers[question.id] === 'A' ? 'checked' : ''}>
                            <div class="flex items-start md:items-center">
                                <span class="bg-blue-100 text-blue-800 w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center font-bold mr-3 md:mr-4 group-hover:bg-blue-200 text-sm md:text-base flex-shrink-0">A</span>
                                <span class="text-gray-700 text-sm md:text-lg leading-relaxed">${question.option_a}</span>
                            </div>
                        </label>
                        <label class="flex items-start md:items-center p-3 md:p-4 rounded-xl hover:bg-green-50 cursor-pointer transition-colors duration-200 group">
                            <input type="radio" name="current_question" value="B" class="mr-3 md:mr-4 w-4 h-4 md:w-5 md:h-5 text-green-600 mt-1 md:mt-0" ${answers[question.id] === 'B' ? 'checked' : ''}>
                            <div class="flex items-start md:items-center">
                                <span class="bg-green-100 text-green-800 w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center font-bold mr-3 md:mr-4 group-hover:bg-green-200 text-sm md:text-base flex-shrink-0">B</span>
                                <span class="text-gray-700 text-sm md:text-lg leading-relaxed">${question.option_b}</span>
                            </div>
                        </label>
                        <label class="flex items-start md:items-center p-3 md:p-4 rounded-xl hover:bg-yellow-50 cursor-pointer transition-colors duration-200 group">
                            <input type="radio" name="current_question" value="C" class="mr-3 md:mr-4 w-4 h-4 md:w-5 md:h-5 text-yellow-600 mt-1 md:mt-0" ${answers[question.id] === 'C' ? 'checked' : ''}>
                            <div class="flex items-start md:items-center">
                                <span class="bg-yellow-100 text-yellow-800 w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center font-bold mr-3 md:mr-4 group-hover:bg-yellow-200 text-sm md:text-base flex-shrink-0">C</span>
                                <span class="text-gray-700 text-sm md:text-lg leading-relaxed">${question.option_c}</span>
                            </div>
                        </label>
                        <label class="flex items-start md:items-center p-3 md:p-4 rounded-xl hover:bg-purple-50 cursor-pointer transition-colors duration-200 group">
                            <input type="radio" name="current_question" value="D" class="mr-3 md:mr-4 w-4 h-4 md:w-5 md:h-5 text-purple-600 mt-1 md:mt-0" ${answers[question.id] === 'D' ? 'checked' : ''}>
                            <div class="flex items-start md:items-center">
                                <span class="bg-purple-100 text-purple-800 w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center font-bold mr-3 md:mr-4 group-hover:bg-purple-200 text-sm md:text-base flex-shrink-0">D</span>
                                <span class="text-gray-700 text-sm md:text-lg leading-relaxed">${question.option_d}</span>
                            </div>
                        </label>
                    </div>
                </div>
            `;
        }
        
        function saveAnswer() {
            const selected = document.querySelector('input[name="current_question"]:checked');
            if (selected) {
                const questionId = questions[currentQuestionIndex].id;
                answers[questionId] = selected.value;
                updateQuestionStatus(currentQuestionIndex, 'answered');
            }
        }
        
        function updateQuestionStatus(index, status) {
            const btn = document.getElementById(`q-${index}`);
            btn.classList.remove('bg-red-500', 'bg-green-500', 'bg-yellow-500');
            if (status === 'answered') {
                btn.classList.add('bg-green-500');
            } else if (status === 'marked') {
                btn.classList.add('bg-yellow-500');
            } else {
                btn.classList.add('bg-red-500');
            }
        }
        
        function saveAndNext() {
            saveAnswer();
            nextQuestion();
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }
        
        function markForReview() {
            markedQuestions.add(currentQuestionIndex);
            updateQuestionStatus(currentQuestionIndex, 'marked');
            nextQuestion();
        }
        
        function startTimer() {
            setInterval(() => {
                if (timeLeft <= 0) {
                    submitTest();
                    return;
                }
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timeDisplay').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function toggleNavigator() {
            const navigator = document.getElementById('questionNavigator');
            navigator.classList.toggle('translate-x-full');
        }
        
        function submitTest() {
            fetch('{% url "submit_test" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({answers: answers, paper_id: paperId})
            })
            .then(response => response.json())
            .then(data => {
                alert(`Test completed! Score: ${data.score}/${data.total}`);
                window.location.href = '{% url "results" %}';
            });
        }
        
        // Initialize test
        initTest();
    </script>
</body>
</html>